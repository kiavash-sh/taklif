<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ‚ÙˆÛŒÙ… Ø¢Ù…ÙˆØ²Ø´ÛŒ - Ú©Ù„Ø§Ø³ 904</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://unpkg.com/moment@2.29.1/min/moment.min.js"></script>
    <script src="https://unpkg.com/moment-jalaali@0.9.2/build/moment-jalaali.js"></script>
</head>
<body>

    <header class="top-header">
        <div class="container">
            <div class="logo">Ø³ÛŒØ³ØªÙ… Ú©Ù„Ø§Ø³ÛŒ 904</div>
            <button class="menu-toggle" id="mobile-menu-btn" aria-label="Ù…Ù†Ùˆ">â˜°</button>
            
            <nav class="main-nav">
                <a href="index.html" class="nav-link">Ø®Ø§Ù†Ù‡</a>
                <a href="tasks.html" class="nav-link">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÚ©Ø§Ù„ÛŒÙ</a>
                <a href="schedule.html" class="nav-link">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ</a>
                <a href="preparation.html" class="nav-link">Ø¢Ù…Ø§Ø¯Ú¯ÛŒ ØªØ¹ÛŒÛŒÙ† Ù…Ø±Ú©Ø²</a>
                <a href="calendar.html" class="nav-link active">ØªÙ‚ÙˆÛŒÙ… Ø¢Ù…ÙˆØ²Ø´ÛŒ</a>
            </nav>
        </div>
    </header>

    <nav id="side-menu">
        <div class="logo" style="margin-bottom: 20px; font-size: 20px;">Ø³ÛŒØ³ØªÙ… Ú©Ù„Ø§Ø³ÛŒ 904</div>
        <a href="index.html" class="nav-link">Ø®Ø§Ù†Ù‡</a>
        <a href="tasks.html" class="nav-link">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÚ©Ø§Ù„ÛŒÙ</a>
        <a href="schedule.html" class="nav-link">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ</a>
        <a href="preparation.html" class="nav-link">Ø¢Ù…Ø§Ø¯Ú¯ÛŒ ØªØ¹ÛŒÛŒÙ† Ù…Ø±Ú©Ø²</a>
        <a href="calendar.html" class="nav-link active">ØªÙ‚ÙˆÛŒÙ… Ø¢Ù…ÙˆØ²Ø´ÛŒ</a>
    </nav>

    <div class="side-menu-overlay" id="menu-overlay"></div>

    <main class="container">
        <div class="page-title">
            <div class="calendar-controls">
                <button id="prev-month" class="nav-btn">â® Ù…Ø§Ù‡ Ù‚Ø¨Ù„</button>
                <h2 id="month-title" style="margin: 0; min-width: 200px;">ØªÙ‚ÙˆÛŒÙ… Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</h2>
                <button id="next-month" class="nav-btn">Ù…Ø§Ù‡ Ø¨Ø¹Ø¯ â¯</button>
            </div>
            <p style="color: var(--text-secondary); margin-top: 10px;">Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÚ©Ø§Ù„ÛŒÙ Ø±ÙˆÛŒ Ø±ÙˆØ²Ù‡Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
        </div>

        <div class="calendar-wrapper">
            <div class="calendar-header">
                <div><span class="desktop-day">Ø´Ù†Ø¨Ù‡</span><span class="mobile-day">Ø´</span></div>
                <div><span class="desktop-day">ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡</span><span class="mobile-day">ÛŒ</span></div>
                <div><span class="desktop-day">Ø¯ÙˆØ´Ù†Ø¨Ù‡</span><span class="mobile-day">Ø¯</span></div>
                <div><span class="desktop-day">Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</span><span class="mobile-day">Ø³</span></div>
                <div><span class="desktop-day">Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</span><span class="mobile-day">Ú†</span></div>
                <div><span class="desktop-day">Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡</span><span class="mobile-day">Ù¾</span></div>
                <div><span class="desktop-day">Ø¬Ù…Ø¹Ù‡</span><span class="mobile-day">Ø¬</span></div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    </main>

    <div id="task-overlay" class="overlay">
        <div class="modal">
            <button class="close-button">&times;</button>
            <h3 id="modal-title"></h3>
            <div id="modal-body"></div>
        </div>
    </div>

    <footer class="bottom-footer">
        <p>&copy; 1404 - ØªÙ…Ø§Ù… Ø­Ù‚ÙˆÙ‚ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            let allTasks = [];
            let displayedDate = null; 

            // Ù†Ú¯Ø§Ø´Øª Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ ØªØ·Ø§Ø¨Ù‚ Ù†Ø§Ù… Ø±ÙˆØ²
            const dayNamesMap = {
                6: 'Ø´Ù†Ø¨Ù‡',
                0: 'ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡',
                0: 'ÛŒÚ©Ø´Ù†Ø¨Ù‡', // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù‡Ø± Ø¯Ùˆ Ø­Ø§Ù„Øª
                1: 'Ø¯ÙˆØ´Ù†Ø¨Ù‡',
                2: 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡',
                2: 'Ø³Ù‡ Ø´Ù†Ø¨Ù‡',
                3: 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡',
                3: 'Ú†Ù‡Ø§Ø± Ø´Ù†Ø¨Ù‡',
                4: 'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡',
                4: 'Ù¾Ù†Ø¬ Ø´Ù†Ø¨Ù‡',
                5: 'Ø¬Ù…Ø¹Ù‡'
            };

            try {
                const res = await fetch('data.json', { cache: 'no-store' });
                if (res.ok) {
                    const data = await res.json();
                    allTasks = Array.isArray(data) ? data : (data.tasks || []);
                }
            } catch (e) { console.error(e); }

            if (typeof moment === 'undefined') {
                document.getElementById('calendar-grid').innerHTML = '<div style="grid-column:1/-1; color:red; text-align:center;">Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ØªÙ‚ÙˆÛŒÙ….</div>';
                return;
            }

            moment.loadPersian({usePersianDigits: true});
            displayedDate = moment();

            document.getElementById('prev-month').addEventListener('click', () => {
                displayedDate.subtract(1, 'jMonth');
                renderCalendar();
            });

            document.getElementById('next-month').addEventListener('click', () => {
                displayedDate.add(1, 'jMonth');
                renderCalendar();
            });

            function renderCalendar() {
                const grid = document.getElementById('calendar-grid');
                const monthTitle = document.getElementById('month-title');
                grid.innerHTML = '';

                const currentJM = displayedDate.jMonth(); 
                const currentJY = displayedDate.jYear();
                
                const persianMonths = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†", "Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª", "Ø®Ø±Ø¯Ø§Ø¯", "ØªÛŒØ±", "Ù…Ø±Ø¯Ø§Ø¯", "Ø´Ù‡Ø±ÛŒÙˆØ±", "Ù…Ù‡Ø±", "Ø¢Ø¨Ø§Ù†", "Ø¢Ø°Ø±", "Ø¯ÛŒ", "Ø¨Ù‡Ù…Ù†", "Ø§Ø³ÙÙ†Ø¯"];
                monthTitle.textContent = `${persianMonths[currentJM]} ${currentJY}`;

                const firstOfMonth = moment(`${currentJY}/${currentJM + 1}/1`, 'jYYYY/jM/jD');
                const daysInMonth = moment.jDaysInMonth(currentJY, currentJM);
                
                // Ø´Ù†Ø¨Ù‡=0 ... Ø¬Ù…Ø¹Ù‡=6 Ø¨Ø±Ø§ÛŒ Ú†ÛŒØ¯Ù…Ø§Ù† Ú¯Ø±ÛŒØ¯
                const weekDayMap = { 6: 0, 0: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6 };
                const startDayIndex = weekDayMap[firstOfMonth.day()]; 

                for (let i = 0; i < startDayIndex; i++) {
                    const empty = document.createElement('div');
                    empty.className = 'calendar-day empty';
                    empty.style.border = 'none';
                    empty.style.cursor = 'default';
                    grid.appendChild(empty);
                }

                const today = moment();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = document.createElement('div');
                    cell.className = 'calendar-day glass-effect';
                    
                    const thisDate = moment(`${currentJY}/${currentJM + 1}/${day}`, 'jYYYY/jM/jD');
                    const isToday = thisDate.format('jYYYY/jM/jD') === today.format('jYYYY/jM/jD');
                    
                    cell.innerHTML = `<span class="day-number">${day}</span>`;
                    
                    if (isToday) {
                        cell.classList.add('today');
                        cell.innerHTML += '<span class="today-badge">Ø§Ù…Ø±ÙˆØ²</span>';
                    }

                    const safeDate = thisDate.clone();
                    cell.addEventListener('click', () => handleDateClick(safeDate, day, persianMonths[currentJM]));
                    
                    grid.appendChild(cell);
                }
            }

            renderCalendar();

            const overlay = document.getElementById('task-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const closeBtn = overlay.querySelector('.close-button');

            function closeModal() { overlay.classList.remove('active'); }
            closeBtn.addEventListener('click', closeModal);
            overlay.addEventListener('click', (e) => { if(e.target === overlay) closeModal(); });

            function normalizeDayName(str) {
                if (!str) return '';
                return str.replace(/\u200c/g, '').replace(/ /g, '').trim();
            }

            function handleDateClick(dateObj, dayNum, monthName) {
                const todayStart = moment().startOf('day');
                const clickedDateStart = dateObj.clone().startOf('day');
                const diff = clickedDateStart.diff(todayStart, 'days');
                
                modalTitle.textContent = `${dayNum} ${monthName}`;
                modalBody.innerHTML = '';

                if (diff < 0) {
                    modalBody.innerHTML = `<div class="calendar-msg error"><div style="font-size:40px; margin-bottom:10px;">ğŸ“…âŒ</div>Ø§ÛŒÙ† ØªØ§Ø±ÛŒØ® Ú¯Ø°Ø´ØªÙ‡ Ø§Ø³Øª.</div>`;
                } else if (diff >= 0 && diff <= 7) {
                    // --- Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ ---
                    // Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯: Ù‡Ù… ØªØ§Ø±ÛŒØ® Ø¯Ù‚ÛŒÙ‚ Ùˆ Ù‡Ù… Ù†Ø§Ù… Ø±ÙˆØ²
                    
                    const gregorianDate = dateObj.format('YYYY-MM-DD');
                    // Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù… Ø±ÙˆØ² Ú©Ù„ÛŒÚ© Ø´Ø¯Ù‡ (Ù…Ø«Ù„Ø§ Ø´Ù†Ø¨Ù‡)
                    const clickedDayName = dayNamesMap[dateObj.day()]; 

                    const tasks = allTasks.filter(t => {
                        // 1. Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ø¯Ù‚ÛŒÙ‚ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù‡Ø³ØªØŒ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
                        if (t.date === gregorianDate) return true;
                        
                        // 2. Ø§Ú¯Ø± ØªØ§Ø±ÛŒØ® Ø¯Ù‚ÛŒÙ‚ Ù†ÛŒØ³ØªØŒ Ø§Ù…Ø§ "Ù†Ø§Ù… Ø±ÙˆØ²" ÛŒÚ©ÛŒ Ø§Ø³Øª (Ø¨Ø±Ø§ÛŒ ØªÚ©Ø§Ù„ÛŒÙ Ù‡ÙØªÚ¯ÛŒ)
                        // Ùˆ Ú†ÙˆÙ† Ø´Ø±Ø· diff <= 7 Ø¨Ø±Ù‚Ø±Ø§Ø± Ø§Ø³ØªØŒ ÛŒØ¹Ù†ÛŒ Ø§ÛŒÙ† Ø´Ù†Ø¨Ù‡ØŒ Ù‡Ù…Ø§Ù† Ø´Ù†Ø¨Ù‡ Ù…Ø¯ Ù†Ø¸Ø± Ù…Ø§Ø³Øª
                        if (clickedDayName && normalizeDayName(t.day) === normalizeDayName(clickedDayName)) {
                            return true;
                        }
                        return false;
                    });

                    if (tasks.length > 0) {
                        tasks.forEach(task => {
                            const taskEl = document.createElement('div');
                            taskEl.className = 'modal-task';
                            
                            let isDone = false;
                            try {
                                const str = `${task.title}-${task.day}-${task.description?.substring(0,10)}`;
                                const taskId = str.replace(/\s/g, '').replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '');
                                isDone = JSON.parse(localStorage.getItem('completedTasks') || '{}')[taskId];
                            } catch(err) {}

                            taskEl.innerHTML = `
                                <div class="modal-task-title" style="${isDone ? 'text-decoration: none; opacity: 0.6; color: #8b949e;' : ''}">
                                    ${isDone ? 'âœ… ' : ''}${task.title}
                                </div>
                                <div class="modal-task-desc">${task.description}</div>
                            `;
                            modalBody.appendChild(taskEl);
                        });
                    } else {
                         modalBody.innerHTML = `<div class="calendar-msg info"><div style="font-size:40px; margin-bottom:10px;">âœ…</div>ØªÚ©Ù„ÛŒÙÛŒ Ù†ÛŒØ³Øª.</div>`;
                    }
                } else {
                    modalBody.innerHTML = `<div class="calendar-msg warning"><div style="font-size:40px; margin-bottom:10px;">ğŸš§</div>Ø¨ÛŒØ´ Ø§Ø² ÛŒÚ© Ù‡ÙØªÙ‡ Ø¢ÛŒÙ†Ø¯Ù‡ (Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡).</div>`;
                }
                overlay.classList.add('active');
            }
        });
    </script>
<script>
        document.addEventListener('DOMContentLoaded', () => {
            const menuBtn = document.getElementById('mobile-menu-btn');
            const sideMenu = document.getElementById('side-menu');
            const menuOverlay = document.getElementById('menu-overlay');
            
            function toggleMenu(state) {
                if (state === 'open') {
                    // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ù†Ùˆ Ùˆ Ø¨Ù„ÙˆØ±
                    sideMenu.classList.add('active');
                    menuOverlay.classList.add('active');
                } else {
                    // ØºÛŒØ±ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…Ù†Ùˆ Ùˆ Ø¨Ù„ÙˆØ±
                    sideMenu.classList.remove('active');
                    menuOverlay.classList.remove('active');
                }
            }

            if (menuBtn && sideMenu && menuOverlay) {
                menuBtn.addEventListener('click', () => toggleMenu('open'));
                menuOverlay.addEventListener('click', () => toggleMenu('close'));

                const navLinks = sideMenu.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        // Ø¨Ø³ØªÙ† Ù…Ù†Ùˆ Ø¨Ø¹Ø¯ Ø§Ø² Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú©
                        setTimeout(() => toggleMenu('close'), 100); 
                    });
                });
            }
        });
    </script>
</body>
</html>