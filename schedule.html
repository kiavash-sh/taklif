<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامه هفتگی - کلاس 904</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="top-header">
        <div class="container">
            <div class="logo">سیستم کلاسی 904</div>
            <nav class="main-nav">
                <a href="index.html" class="nav-link">خانه</a>
                <a href="tasks.html" class="nav-link">مشاهده تکالیف</a>
                <a href="schedule.html" class="nav-link active">برنامه هفتگی</a>
                <a href="preparation.html" class="nav-link">آمادگی تعیین مرکز</a>
                <a href="calendar.html" class="nav-link">تقویم آموزشی</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="page-title">
            <h2>برنامه درسی کلاس ۹۰۴ - <span id="week-status"></span></h2>
        </div>
        <div class="schedule-grid">
            <div class="grid-header">ایام هفته</div>
            <div class="grid-header">ساعت اول (۷:۳۰ - ۸:۵۵)</div>
            <div class="grid-header">ساعت دوم (۹:۱۰ - ۱۰:۴۰)</div>
            <div class="grid-header">ساعت سوم (۱۱:۰۰ - ۱۲:۲۵)</div>
            <div class="grid-header">ساعت چهارم (۱۲:۵۰ - ۱۴:۱۵)</div>
            <div class="day-label" data-day="شنبه">شنبه</div>
            <div class="class-cell" data-subject="قرآن"><span class="subject">قرآن</span><span class="teacher">استاد بیات</span></div>
            <div class="class-cell" data-subject="ادبیات فارسی"><span class="subject">ادبیات فارسی</span><span class="teacher">استاد تیموری</span></div>
            <div class="class-cell" data-subject="فرهنگ و هنر"><span class="subject">فرهنگ و هنر</span><span class="teacher">استاد خلیلی</span></div>
            <div class="class-cell" data-subject="جبر"><span class="subject">جبر</span><span class="teacher">استاد ابراهیمی فرد</span></div>
            <div class="day-label" data-day="یکشنبه">یک‌شنبه</div>
            <div class="class-cell" data-subject="مطالعات اجتماعی"><span class="subject">مطالعات اجتماعی</span><span class="teacher">استاد نظری نژاد</span></div>
            <div class="class-cell" data-subject="زبان عربی"><span class="subject">زبان عربی</span><span class="teacher">استاد هاشمی</span></div>
            <div class="class-cell" data-subject="فیزیک"><span class="subject">فیزیک</span><span class="teacher">استاد یامی</span></div>
            <div class="class-cell" data-subject="نگارش"><span class="subject">نگارش</span><span class="teacher">استاد طیبی</span></div>
            <div class="day-label" data-day="دوشنبه">دوشنبه</div>
            <div class="class-cell" data-subject="زیست شناسی"><span class="subject">زیست شناسی</span><span class="teacher">استاد لعل</span></div>
            <div class="class-cell" data-subject="کار و فناوری"><span class="subject">کار و فناوری</span><span class="teacher">استاد خلیلی</span></div>
            <div class="class-cell" data-subject="ادبیات تکمیلی / املا"><span class="subject">ادبیات تکمیلی / املا</span><span class="teacher">استاد تیموری</span></div>
            <div class="class-cell alternating" data-subject-odd="دفاعی" data-subject-even="گام های موفقیت">
                <div class="subject"><span data-week="odd">دفاعی</span><span data-week="even">گام‌های موفقیت</span></div>
                <span class="teacher">استاد حسن زاده / استاد جوکار</span>
            </div>
            <div class="day-label" data-day="سه‌شنبه">سه‌شنبه</div>
            <div class="class-cell alternating" data-subject-odd="مطالعات اجتماعی" data-subject-even="فیزیک">
                <div class="subject"><span data-week="odd">مطالعات</span><span data-week="even">فیزیک</span></div>
                <span class="teacher">استاد نظری نژاد / استاد یامی</span>
            </div>
            <div class="class-cell" data-subject="هندسه"><span class="subject">هندسه</span><span class="teacher">استاد برنگ</span></div>
            <div class="class-cell alternating" data-subject-odd="زمین شناسی" data-subject-even="دفاعی">
                <div class="subject"><span data-week="odd">زمین شناسی</span><span data-week="even">دفاعی</span></div>
                <span class="teacher">استاد لعل / استاد حسن زاده</span>
            </div>
            <div class="class-cell" data-subject="زبان انگلیسی"><span class="subject">زبان انگلیسی</span><span class="teacher">استاد آذری</span></div>
            <div class="day-label" data-day="چهارشنبه">چهارشنبه</div>
            <div class="class-cell" data-subject="تربیت بدنی"><span class="subject">تربیت بدنی</span><span class="teacher">استاد علیخانی</span></div>
            <div class="class-cell" data-subject="شیمی"><span class="subject">شیمی</span><span class="teacher">استاد مدیری</span></div>
            <div class="class-cell" data-subject="جبر"><span class="subject">جبر</span><span class="teacher">استاد ابراهیمی فرد</span></div>
            <div class="class-cell" data-subject="پیام آسمانی"><span class="subject">پیام آسمانی</span><span class="teacher">استاد آهنی</span></div>
        </div>
    </main>
    
    <div id="task-overlay" class="overlay">
        <div class="modal">
            <button class="close-button">&times;</button>
            <h3 id="modal-title"></h3>
            <div id="modal-body"></div>
        </div>
    </div>

    <footer class="bottom-footer">
        <p>&copy; 1404 - تمام حقوق برای شما محفوظ است.</p>
    </footer>

<script>
        document.addEventListener('DOMContentLoaded', function() {
            let allTasks = [];
            let currentWeekType = 'even'; // مقدار پیش‌فرض

            const subjectAliases = {
                'جبر': ['جبر', 'ریاضی'],
                'هندسه': ['هندسه', 'ریاضی'],
                'قرآن': ['قرآن', 'قران'],
                'فرهنگ و هنر': ['فرهنگ و هنر', 'هنر'],
                'مطالعات اجتماعی': ['مطالعات اجتماعی', 'اجتماعی', 'مطالعات'],
                'زبان عربی': ['زبان عربی', 'عربی'],
                'زیست شناسی': ['زیست شناسی', 'زیست', 'زیست و زمین', 'زمین شناسی', 'زمین'],
                'زبان انگلیسی': ['زبان انگلیسی', 'زبان'],
                'تربیت بدنی': ['تربیت بدنی', 'ورزش'],
                'پیام آسمانی': ['پیام آسمانی', 'پیام', 'پیام اسمانی']
            };
            
            function normalizeString(str) {
                if (!str) return '';
                return str.replace(/\u200c/g, '').replace(/ /g, '').trim();
            }

            async function fetchData() {
                try {
                    const res = await fetch('data.json', { cache: 'no-store' });
                    if (!res.ok) throw new Error('Failed to load data');
                    
                    // خواندن ساختار جدید
                    const data = await res.json();
                    allTasks = data.tasks || [];
                    
                    // خواندن نوع هفته از جیسون
                    if (data.weekType) {
                        currentWeekType = data.weekType; // 'odd' or 'even'
                    }
                    
                } catch (error) { 
                    console.error(error);
                    // Fallback if needed
                    currentWeekType = 'even';
                }
            }

            function initializeSchedule() {
                // نمایش متن وضعیت هفته
                const statusText = document.getElementById('week-status');
                statusText.textContent = (currentWeekType === 'even') ? 'هفته زوج' : 'هفته فرد';
                
                // رنگ‌آمیزی برای تاکید بیشتر روی وضعیت هفته
                statusText.style.color = 'var(--accent-primary)';
                statusText.style.textShadow = '0 0 10px rgba(88, 166, 255, 0.5)';

                // فعال/غیرفعال کردن کلاس‌ها
                document.querySelectorAll('.alternating .subject').forEach(cell => {
                    const odd = cell.querySelector('[data-week="odd"]');
                    const even = cell.querySelector('[data-week="even"]');
                    
                    // پاک کردن کلاس‌های قبلی
                    odd.classList.remove('active', 'inactive');
                    even.classList.remove('active', 'inactive');

                    if (currentWeekType === 'even') {
                        even.classList.add('active');
                        odd.classList.add('inactive');
                    } else {
                        odd.classList.add('active');
                        even.classList.add('inactive');
                    }
                });
            }

            // ... (کد مربوط به مودال و ایونت لیسنرها بدون تغییر باقی می‌ماند، فقط بخش logic filtering از allTasks استفاده می‌کند که قبلا اصلاح شد) ...
            
            const overlay = document.getElementById('task-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const closeButton = overlay.querySelector('.close-button');

            function openModal() { overlay.classList.add('active'); }
            function closeModal() { overlay.classList.remove('active'); }
            closeButton.addEventListener('click', closeModal);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModal(); });

            function showTasksInModal(title, tasks) {
                modalTitle.textContent = title;
                modalBody.innerHTML = '';
                if (tasks.length === 0) {
                    modalBody.innerHTML = '<p class="no-task">تکلیفی برای این مورد ثبت نشده است.</p>';
                } else {
                    tasks.forEach(task => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'modal-task';
                        taskEl.innerHTML = `<div class="modal-task-title">${task.title}</div><div class="modal-task-desc">${task.description}</div>`;
                        modalBody.appendChild(taskEl);
                    });
                }
                openModal();
            }
            
            function setupEventListeners() {
                document.querySelectorAll('.class-cell, .day-label').forEach(cell => {
                    cell.addEventListener('click', () => {
                        let currentElement = cell;
                        let day = '';
                        while (currentElement) {
                            if (currentElement.classList.contains('day-label')) {
                                day = currentElement.dataset.day;
                                break;
                            }
                            currentElement = currentElement.previousElementSibling;
                        }
                        
                        if (cell.classList.contains('day-label')) {
                            const relatedTasks = allTasks.filter(task => normalizeString(task.day) === normalizeString(day));
                            showTasksInModal(`تکالیف روز ${day}`, relatedTasks);
                        }
                        
                        if (cell.classList.contains('class-cell')) {
                            let mainSubjects = [];
                            let modalTitleText = '';

                            if (cell.classList.contains('alternating')) {
                                const subjectOdd = cell.dataset.subjectOdd;
                                const subjectEven = cell.dataset.subjectEven;
                                mainSubjects.push(subjectOdd, subjectEven);
                                modalTitleText = `تکالیف: ${subjectOdd} / ${subjectEven}`;
                            } else {
                                const subject = cell.dataset.subject;
                                mainSubjects.push(subject);
                                modalTitleText = `تکالیف درس: ${subject}`;
                            }

                            const relatedTasks = allTasks.filter(task => {
                                const isCorrectDay = normalizeString(task.day) === normalizeString(day);
                                if (!isCorrectDay) return false;

                                const normalizedTaskTitle = normalizeString(task.title);
                                return mainSubjects.some(mainSubject => {
                                    const aliases = subjectAliases[mainSubject] || [mainSubject];
                                    const normalizedAliases = aliases.map(alias => normalizeString(alias));
                                    return normalizedAliases.includes(normalizedTaskTitle);
                                });
                            });

                            showTasksInModal(modalTitleText, relatedTasks);
                        }
                    });
                });
            }

            async function main() {
                await fetchData(); // اول دیتا و نوع هفته را می‌گیرد
                initializeSchedule(); // بعد UI را آپدیت می‌کند
                setupEventListeners();
            }

            main();
        });
    </script>
</body>
</html>